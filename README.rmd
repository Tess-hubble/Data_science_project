---
output:
  md_document:
    variant: markdown_github
---

# Purpose

Proposed layout: EDA (univariate, bivariate analysis), model (compare hard to interpret results against bivariate)

```{r}

library(tidyverse)
library(ranger)
library(caret)
library(tidyr)
library(corrplot)
library(gridExtra)


# loading and merging data

art <- read_csv("C:\\Users\\tessa\\OneDrive\\Desktop\\Masters 2023\\Data science\\Project\\data\\priceseries_art_products_purch_rec.csv")
purchases <- read_csv("C:\\Users\\tessa\\OneDrive\\Desktop\\Masters 2023\\Data science\\Project\\data\\Full_Rec_Mooc_Purchases.csv") %>% select(mooc_id, buyer_id)
auctions <- read_csv("C:\\Users\\tessa\\OneDrive\\Desktop\\Masters 2023\\Data science\\Project\\data\\Full_Rec_Mooc.csv") %>% 
    select(mooc_id, date, auction_tot) %>% 
    mutate(auction_tot= as.numeric(auction_tot)) 
final_df <- data_loader("C:\\Users\\tessa\\OneDrive\\Desktop\\Masters 2023\\Data science\\Project\\data")
merged_df <- merger(final_df, auctions) %>% 
    filter(unit_price>0)

# auction example table
auction_example <- read_csv("C:\\Users\\tessa\\OneDrive\\Desktop\\Masters 2023\\Data science\\Project\\data\\Full_Rec_Mooc_Purchases.csv") %>% arrange(mooc_id) %>% 
    select(mooc_id, purchase_id, price, buyer_id, goods) %>% 
    filter(mooc_id=="MOOC10/10.1")
auction_example_goods <- data_auction("C:\\Users\\tessa\\OneDrive\\Desktop\\Masters 2023\\Data science\\Project\\data") %>% select(-bundle, -unit_price, -count) %>% mutate(year = substr(date, 1, 4))
auction_table <- full_join(auction_example, auction_example_goods, by = c("mooc_id", "purchase_id")) %>% 
    mutate(year="1770") %>% 
    select(-date)

# summing total value of items within good type per auction
total_value_good_auction <- total_purchase_value(goods = c("books", "art_products", "balance", 
                                                           "beds", "cattle", "chairs", "china", 
                                                           "clocks", "coatrack", "cups", "guns", 
                                                           "hammers", "horse_cart", "horses", "irons", 
                                                           "jewlery", "lamps", "oven", "plates", 
                                                           "pot", "plough", "sheep", "slaves", "tables", 
                                                           "utensils", "wagons")) %>% 
    spread(key = type, value = total_value, fill = 0)
       
    
# summing the number of items within a good type per auction 
goods <- c("books", "art_products", "balance", "beds", "cattle", "chairs", "china", "clocks", 
           "coatrack", "cups", "guns", "hammers", "horse_cart", "horses", "irons", "jewlery", 
           "lamps", "oven", "plates", "pot", "plough", "sheep", "slaves", "tables", 
                                                     "utensils", "wagons")
goods_id_str <- paste0("total_", goods)

total_number_good_auction <-  good_counter(goods = c("books", "art_products", "balance", 
                                                     "beds", "cattle", "chairs", "china", 
                                                     "clocks", "coatrack", "cups", "guns", 
                                                     "hammers", "horse_cart", "horses", "irons", 
                                                     "jewlery", "lamps", "oven", "plates", 
                                                     "pot", "plough", "sheep", "slaves", "tables", 
                                                     "utensils", "wagons")) %>% 
    distinct(mooc_id, .keep_all=TRUE) %>% 
    ungroup() %>% 
    dplyr::select(mooc_id, total_goods, goods_id) %>% 
    arrange(mooc_id) %>% 
    pivot_wider(names_from = goods_id, values_from = total_goods) %>% 
    as.data.frame() %>% 
    mutate(across(all_of(goods_id_str), ~ ifelse(is.na(.), 0, .)))

household_items <- c("beds", "chairs", "china", "clocks", "coatrack", "cups", "irons", "lamps", "tables", "balance")
kitchen_items <- c("oven", "plates", "pot", "utensils")
farming_items <- c("cattle", "sheep", "plough", "wagons", "horses", "horse_cart", "guns", "hammers")
select_items <- c("books", "jewelry", "slaves", "art_products")



# determining auction size

auction_size <- merged_df %>% 
        group_by(mooc_id) %>% 
    mutate(auction_size=sum(count)) %>% 
    distinct(mooc_id, .keep_all=TRUE) %>% 
    dplyr::select(mooc_id, date, auction_tot, auction_size) 

interim_df <- left_join(total_value_good_auction, total_number_good_auction, "mooc_id")
pen_ultimate_df <- left_join(interim_df, auction_size, "mooc_id")


# counting attendance by titled men and women per auction
women <- titledwomen_locator(titled_women, purchases$buyer_id) %>% 
    as.numeric()
men <- titledmen_locator(titled_men, purchases$buyer_id) %>% 
    as.numeric()
purchases_df <- tibble(purchases, women, men)
purchases_df <- title_counter(purchases_df) 
   

# merging titles and auctions
model_df <- inner_join(pen_ultimate_df,purchases_df, by="mooc_id")
model_df <- model_df %>% 
    mutate(year = substr(date, 1, 4)) %>% 
    arrange(year) %>% 
    group_by(year) %>% 
      mutate(date=n())

# assigning value from 1 to N for each year
model_df$date <- as.numeric(match(model_df$year, unique(model_df$year)))

# filtering table based on recording errors in year transcription
model_df <- model_df %>% 
    filter(date<103) %>% 
    filter(date!=1)  %>% 
    filter(auction_tot>0) %>% 
    filter(auction_tot!=-Inf)

# table for machine learning models
ml_df <- model_df %>% 
     ungroup() %>% 
    dplyr::select(-year, -mooc_id) %>% 
    na.omit() %>% 
  mutate(across(everything(), ~ifelse(. != 0, log(.), .)))
    
ml_df$auction_size <- as.numeric(ml_df$auction_size)
```


# descriptives

```{r}

Mean_auction_total <- mean(model_df$auction_tot)
sd_auction_total <- sd(model_df$auction_tot)

summary(model_df)


# trying out plots 
trial_plots <- model_df %>% 
  filter(year >= 1720) %>% 
  mutate(time_period = ifelse(year > 1720 & year < 1730, "1720-1730", 
                              ifelse(year >= 1730 & year < 1740, "1730-1740", 
                                     ifelse(year >= 1740 & year < 1750, "1740-1750",
                                            ifelse(year >= 1750 & year < 1760, "1750-1760", 
                                                   ifelse(year >= 1760 & year < 1770, "1760-1770",
                                                          ifelse(year >= 1770 & year < 1780, "1770-1780",
                                                                 ifelse(year >= 1780 & year < 1790, "1780-1790",
                                                                        ifelse(year >= 1790 & year < 1800, "1790-1800", 
                                                                               ifelse(year >= 1800 & year < 1810, "1800-1810", 
                                                                                      ifelse(year >= 1810 & year < 1820, "1810-1820", NA))))))))))) %>% 
    filter(time_period!="NA")


# total auction value graph 
custom_breaks <- c(1720, 1740, 1760, 1780, 1800, 1820)
custom_labels <- c("1720", "1740", "1760", "1780", "1800", "1820")
trial_plots$year <- as.numeric(trial_plots$year)

total_auction <- ggplot(trial_plots, aes(x = year, y = auction_tot)) +
  geom_point() +
  labs(title = "Total auction value over time",
       x = "Year", y = "Auction total (Rix-dollars)") +
  scale_x_continuous(breaks = custom_breaks, labels = custom_labels) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, vjust = 2, face="bold"),
        axis.title.y = element_text(margin = margin(r = 10)),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        plot.margin = margin(15, 10, 15, 10))

# plotting all goods
household_items <- c("beds", "chairs", "china", "clocks", "coatrack", "cups", "irons", "lamps", "tables", "balance")
household_items <- paste0("total_", household_items)
kitchen_items <- c("oven", "plates", "pot", "utensils")
kitchen_items <- paste0("total_", kitchen_items)
farming_items <- c("cattle", "sheep", "plough", "wagons", "horses", "horse_cart", "guns", "hammers")
farming_items <- paste0("total_", farming_items)
select_items <- c("books", "slaves", "art_products")
select_items <- paste0("total_", select_items)

# household goods

all_goods_household <- trial_plots %>% 
    select(mooc_id, year, time_period, household_items) %>% 
    group_by(time_period) %>% 
    summarise(total_beds=mean(total_beds), 
              total_chairs=mean(total_chairs), 
              total_china=mean(total_china), 
              total_clocks=mean(total_clocks), 
              total_coatrack=mean(total_coatrack), 
              total_cups=mean(total_cups), 
              total_irons=mean(total_irons), 
              total_lamps=mean(total_lamps), 
              total_tables=mean(total_tables), 
              total_balance=mean(total_balance)) %>% 
        gather(household_goods, value, household_items) %>% 
    ungroup()


household_goods <- ggplot(all_goods_household, aes(x=time_period, y=value, fill= household_goods)) +
    geom_bar(stat="identity")+
    scale_fill_manual(values = c("#FFB400", "#FFC740", "#C20008", "#FF020D", "#13AFEF", "#009944", "#8C4799", "#FF6600", "#A6BDDB", "#00B33C"))+
     labs(title = "Number of houshold goods per auction over time",
       x = "Year", y = "Good value (Rix-dollars)", 
       fill = "Household goods") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, vjust = 2, face="bold"),
        axis.title.y = element_text(margin = margin(r = 10)),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

# kitchen items 

all_goods_kitchen <- trial_plots %>% 
    select(mooc_id, year, time_period, kitchen_items) %>% 
    group_by(time_period) %>% 
    summarise(total_oven=mean(total_oven), 
              total_plates=mean(total_plates), 
              total_pot=mean(total_pot), 
              total_utensils=mean(total_utensils)) %>% 
        gather(kitchen_goods, value, kitchen_items) %>% 
    ungroup()

kitchen_goods <- ggplot(all_goods_kitchen, aes(x=time_period, y=value, fill= kitchen_goods)) +
    geom_bar(stat="identity")+
    scale_fill_manual(values = c("#FFB400", "#13AFEF", "#A6BDDB", "#00B33C" ))+
     labs(title = "Number of kitchen goods per auction over time",
       x = "Year", y = "Good value (Rix-dollars)", 
       fill = "Kitchen goods") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, vjust = 2, face="bold"),
        axis.title.y = element_text(margin = margin(r = 10)),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        plot.margin = margin(15, 10, 15, 10))

# farming items

all_goods_farm <- trial_plots %>% 
    select(mooc_id, year, time_period, farming_items) %>% 
    group_by(time_period) %>% 
    summarise(total_cattle=mean(total_cattle), 
              total_sheep=mean(total_sheep), 
              total_plough=mean(total_plough), 
              total_wagons=mean(total_wagons), 
              total_horses=mean(total_horses), 
              total_horse_cart=mean(total_horse_cart), 
              total_guns=mean(total_guns), 
              total_hammers=mean(total_hammers)) %>% 
        gather(farming_goods, value, farming_items) %>% 
    ungroup()

farming_goods <- ggplot(all_goods_farm, aes(x=time_period, y=value, fill= farming_goods)) +
    geom_bar(stat="identity")+
    scale_fill_manual(values = c("#FFB400", "#FFC740", "#C20008", "#FF020D", "#13AFEF", "#009944", "#8C4799", "#FF6600"))+
     labs(title = "Value of farming goods per auction over time",
       x = "Year", y = "Good value (Rix-dollars)", 
       fill = "Farming goods") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, vjust = 2, face="bold"),
        axis.title.y = element_text(margin = margin(r = 10)),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        plot.margin = margin(15, 10, 15, 10))

# select items

all_goods_select <- trial_plots %>% 
    select(mooc_id, year, time_period, select_items) %>% 
    group_by(time_period) %>% 
    summarise(total_books=mean(total_books),
              total_slaves=mean(total_slaves), 
              total_art_products=mean(total_art_products)) %>% 
        gather(select_goods, value, select_items) %>% 
    ungroup()

select_goods <- ggplot(all_goods_select, aes(x=time_period, y=value, fill= select_goods)) +
    geom_bar(stat="identity")+
    scale_fill_manual(values = c("#FFB400", "#C20008", "#009944"))+
     labs(title = "Value of select goods per auction over time",
       x = "Year", y = "Good value (Rix-dollars)", 
       fill = "Select goods") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, vjust = 2, face="bold"),
        axis.title.y = element_text(margin = margin(r = 10)),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        plot.margin = margin(15, 10, 15, 10))

 
# focus on 5 most common goods and how bundle changes over time 

big_five_df <- model_df %>% 
  filter(year >= 1720) %>% 
  mutate(time_period = ifelse(year > 1720 & year < 1755, "1720-1755", 
                              ifelse(year >= 1755 & year < 1790, "1755-1790", 
                                     ifelse(year >= 1790 & year < 1820, "1790-1820", "NA"))))%>% filter(time_period!="NA") %>% 
    dplyr::select(time_period, total_cattle, total_sheep, total_horses, total_slaves, total_utensils) %>% 
    gather(good, value, total_cattle, total_sheep, total_horses, total_slaves, total_utensils) %>% 
    filter(value<200)
    
big_five_boxplots <- ggplot(big_five_df, aes(x = time_period, y = value, fill = good)) +
  geom_boxplot() +
  facet_wrap(~time_period, scales = "free_x") +
  labs(title = "Boxplots of the most frequently purchased goods by time period",
       x = "Time Period",
       y = "Number of purchases",
       fill = "Good type") +
  scale_fill_manual(values = c("#FFB400", "#C20008", "#A6BDDB", "#00B33C", "#FF6600")) +
  theme(plot.title = element_text(hjust = 0.5, vjust = 2, face = "bold"),
        axis.title.y = element_text(margin = margin(r = 10)),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.text.x = element_blank(),
        plot.margin = margin(15, 10, 15, 10))


# attendance

library("remotes")
library("ggstream")
library(ggplot2)

attendance_df <-  model_df %>% 
  filter(year >= 1720) %>% 
  mutate(time_period = ifelse(year > 1720 & year < 1730, "1720-1730", 
                              ifelse(year >= 1730 & year < 1740, "1730-1740", 
                                     ifelse(year >= 1740 & year < 1750, "1740-1750",
                                            ifelse(year >= 1750 & year < 1760, "1750-1760", 
                                                   ifelse(year >= 1760 & year < 1770, "1760-1770",
                                                          ifelse(year >= 1770 & year < 1780, "1770-1780",
                                                                 ifelse(year >= 1780 & year < 1790, "1780-1790",
                                                                        ifelse(year >= 1790 & year < 1800, "1790-1800", 
                                                                               ifelse(year >= 1800 & year < 1810, "1800-1810", 
                                                                                      ifelse(year >= 1810 & year < 1820, "1810-1820", NA))))))))))) %>% 
    filter(time_period!="NA") %>% 
    group_by(time_period) %>% 
    summarise(women=mean(women_tot), 
              men=mean(men_total)) %>% 
    gather(attendance, number, women, men)
attendance_df$number <- as.numeric(attendance_df$number)


attendance_plot <- ggplot(attendance_df, aes(x = time_period, y = number, fill = attendance)) +
  geom_bar(stat = "identity", position = "stack")+
      labs(title = "Average attendance by titled men and women over time",
       x = "Time Period",
       y = "Average attendance",
       fill = "Titled") +
  scale_fill_manual(values = c("#00B33C", "#13AFEF")) +
  theme(plot.title = element_text(hjust = 0.5, vjust = 2, face = "bold"),
        axis.title.y = element_text(margin = margin(r = 10)),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        plot.margin = margin(15, 10, 15, 10))
    
# bivariate analysis 

library(gridEtxra)
auction_size <- scatter_plotter(trial_plots$auction_size, "Plotting auction total values against auction sizes","Auction size (number of goods on auction)")
cattle <- scatter_plotter(trial_plots$total_cattle, "Plotting auction total values against number\n of cattle purchased at an auction","Total number of cattle purhased per auction")
slaves <- scatter_plotter(trial_plots$total_slaves, "Plotting auction total values against number\n of slaves purchased at an auction","Total number of slaves purhased per auction")
sheep <- scatter_plotter(trial_plots$total_sheep, "Plotting auction total values against number\n of sheep purchased at an auction","Total number of sheep purhased per auction")
horses <- scatter_plotter(trial_plots$total_horses, "Plotting auction total values against number\n of cattle purchased at an auction","Total number of cattle purhased per auction")
men <- scatter_plotter(trial_plots$men_total, "Plotting auction total values against number\n of titled men attending an auction","Total number of titled men per auction")

bivariat_plot <- grid.arrange(auction_size, cattle, slaves, sheep, horses, men, ncol = 3, nrow = 2)

## correlation matrix 
library("Hmisc")
library("GGally")

corr_ml_dff <- ml_df
corr_ml_dff <- as.dist(round(cor(corr_ml_dff),2))
ml_corr <- rcorr(as.matrix(corr_ml_dff))
ggcorr(ml_df)+
    labs(title="Correlation matrix")+
    theme(text = element_text(size = 12, face="bold"))

```

feature and target transformations
```{r}

auction_unlogged <- unlogged_distribution(model_df$auction_tot, "Distribution of total auction values", "Total auction value")
auction_logged <- model_df %>% mutate(auction_tot=log(auction_tot)) %>% 
     ggplot(aes(x=auction_tot))+
    geom_density()+
    labs(title = "Distribution of logged\n total auction values",
         x = "Logged total auction value", y = "Density") +
    theme(plot.title = element_text(hjust = 0.5, vjust = 2, face="bold"))
cattle_unlogged <- unlogged_distribution(model_df$cattle, "Distribution of cattle\n values", "Total cattle value per auction")
cattle_logged <- model_df %>% mutate(cattle=log(cattle)) %>% 
     ggplot(aes(x=cattle))+
    geom_density()+
    labs(title = "Distribution of logged\n cattle values",
         x = "Logged cattle value", y = "Density") +
    theme(plot.title = element_text(hjust = 0.5, vjust = 2, face="bold"))
men_attend_unlogged <- unlogged_distribution(model_df$cattle, "Distribution of titled\n men auction attendance", "Titled men attendance\n per auction")
men_attend_logged <- model_df %>% mutate(men_total=log(men_total)) %>% 
     ggplot(aes(x=men_total))+
    geom_density()+
    labs(title = "Distribution of logged\n titled men attendance",
         x = "Logged titled men\n attendance per auction", y = "Density") +
    theme(plot.title = element_text(hjust = 0.5, vjust = 2, face="bold"))

distribution_plots <- grid.arrange(auction_unlogged, auction_logged, cattle_unlogged, cattle_logged, men_attend_unlogged, men_attend_logged, ncol = 2, nrow = 3)
    

```

stick to tuning two parameters: mtry(number of variables randomly sampled at each split) & ntree(number of trees to grow)
-two elements of randomness: random sub-sample obtained via bootstrapping on which a single tree is built & random set of features selected for each tree
- randomness: decreases variance in prediction at cost of creating slight bias in each tree but aggregating the trees using voting tends to eliminate bias = both bias and variance are minimised 
- can choose the way each tree is build using hyperparameters

# number of trees in random forest: 10p
# mtry (split variable randomisation): helps to balance low tree correlation with reasonable predictive strength - However, when there are fewer relevant predictors (e.g., noisy data) a higher value of  mtry
#  Node size is probably the most common hyperparameter to control tree complexity: if your data has many noisy predictors and higher  mtry
  values are performing best, then performance may improve by increasing node size (i.e., decreasing tree depth and complexity
  # The sample size parameter determines how many observations are drawn for the training of each tree. Decreasing the sample size leads to more diverse trees and thereby lower between-tree correlation, which can have a positive effect on the prediction accuracy. Consequently, if there are a few dominating features in your data set, reducing the sample size can also help to minimize between-tree correlation- Assess 3–4 values of sample sizes ranging from 25%–100% 

  tends to perform better because it makes it more likely to select those features with the strongest signal
# regression
```{r}

reg <- lm(auction_tot ~ ., data = ml_df)
summary(reg)
```


# splitting into testing and training

```{r}
# testing and training 
set.seed(123)
indices <- sample(nrow(ml_df))
train_size <- floor(0.6 * nrow(ml_df))
training_data <- ml_df[indices[1:train_size], ]
testing_data <- ml_df[indices[(train_size + 1):nrow(ml_df)], ]

```

# knn method

```{r}

sampling_strat <- caret::trainControl(
    method="repeatedcv", 
    number=10, 
    repeats=5
)

hyper_grid <- expand.grid(k = seq(1, 25, by = 1))

knn_fit <- train(
  auction_tot ~ ., 
  data = training_data, 
  method = "knn", 
  trControl = sampling_strat, 
  tuneGrid = hyper_grid,
  metric = "RMSE"
)
    
knn_plot <- ggplot(knn_fit)+
    labs(title= "Optimal k-value", 
         x="Neighbours")+
    theme(plot.title = element_text(hjust = 0.5, vjust = 2, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
# k = 5 has the lowest RMSE
# RMSE is 1.16

library(caret)

# Train the KNN model with the chosen k value
k <- 5
knn_model <- train(
  auction_tot ~ .,
  data = training_data,
  method = "knn",
  trControl = sampling_strat,
  tuneGrid = data.frame(k = k),
  metric = "RMSE"
)
knn_model # RMSE is 1.16

# Make predictions on the testing data
predictions_knn <- predict(knn_model, newdata = testing_data)
rmse_knn_test <- RMSE(predictions_knn, testing_data$auction_tot) # RMSE is 0.93

# plot
prediction_knn_df <- data.frame(
  Actual = testing_data$auction_tot,
  Predicted = predictions_knn
)

knn_predictions_plot <- ggplot(prediction_knn_df, aes(x = Actual, y = Predicted)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "#C20008") +
  labs(title = "Predictions vs Actual Values", x = "Actual", y = "Predicted")+
    theme(plot.title = element_text(hjust = 0.5, vjust = 2, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8))


```

# random forest

```{r}

dim(ml_df)
n_features <- length(setdiff(names(training_data), "auction_tot"))


# train a default random forest model
training_rf <- ranger(
  auction_tot ~ ., 
  data = training_data,
  mtry = floor(n_features / 3),
  respect.unordered.factors = "order",
  importance= "permutation",
  seed = 123
)
training_rf
default_rmse <- sqrt(training_rf$prediction.error) # RMSE: 0.94
rf_importance <- ranger::importance(training_rf)
sort(rf_importance, decreasing = TRUE)

# lowering RMSE

# parameter grid
parameter_grid <- expand.grid(
  mtry = c(floor(n_features / 3)),
  num.trees = c(100, 300, 500),
  min.node.size = c(1, 5, 10)
)

results <- lapply(1:nrow(parameter_grid), function(i) {
  model <- ranger(
    auction_tot ~ .,
    data = training_data,
    num.trees = parameter_grid$num.trees[i],
    mtry = parameter_grid$mtry[i],
    min.node.size = parameter_grid$min.node.size[i],
    respect.unordered.factors = "order",
    importance = "permutation",
    seed = 123
  )
  predictions <- predict(model, data = testing_data)$predictions
  rmse <- sqrt(mean((predictions - testing_data$auction_tot)^2))
  list(model = model, rmse = rmse)
})

best_model_index <- which.min(sapply(results, function(x) x$rmse))
best_model <- results[[best_model_index]]$model

predictions_rf <- predict(best_model, data = testing_data)$predictions
rmse_rf <- sqrt(mean((predictions_rf - testing_data$auction_tot)^2)) # RMSE:0.769

rf_predictions <- data.frame(
  Actual = testing_data$auction_tot,
  Predictions = predictions_rf
)

# plot
rf_plot <- ggplot(rf_predictions, aes(x = Actual, y = Predictions)) +
  geom_point() +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "#C20008") +
  labs(title = "Predictions vs Actual Values", x = "Actual", y = "Predicted")+
    theme(plot.title = element_text(hjust = 0.5, vjust = 2, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
    



```

# importance plot
```{r}

rf_importance_df <- data.frame(
    Importance = training_rf[["variable.importance"]]
) %>% rownames_to_column() %>% arrange(desc(Importance))
colnames(rf_importance_df) <- c("Feature", "Importance")


importance_plot <- ggplot(importance_df, aes(x= reorder(Feature, -Importance), y = Importance)) +
  geom_bar(stat = "identity", fill = "#C20008" ) +
  labs(title = "Feature Importance", x = "Feature", y = "Importance") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=7))+
    theme(plot.title = element_text(hjust = 0.5, vjust = 2, face = "bold"))
```

